function clamp(t,e,n){return Math.min(Math.max(t,e),n)}function cloneDeep(t){return JSON.parse(JSON.stringify(t))}function dateToMMSS(t){if(!isNaN(t)){var e=Math.round(t/60<<0),n=Math.round(t%60);return(e.toString().length>=2?e:"0"+e)+":"+(n.toString().length>=2?n:"0"+n)}}function getBatchColor(t){t.annotations||(t.annotations=[]);var e=t.annotations[0];if("undefined"!=typeof e&&e.author&&("undefined"!=typeof e.author.name||"undefined"!=typeof e.author.username)){var n="undefined"!=typeof e.author.name?e.author.name:e.author.username,i=fnv1aHashString(n),o=getAnnotationColorForHash(i);return o}}function getParameterByName(t,e){e||(e=window.location.href),t=t.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)"),i=n.exec(e);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}function stringToHTMLSafe(t){var e={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;","\n":"<br>"};return t.replace(/[<>&"'\n]/g,function(t){return e[t]})}function cssPercent(t){return 100*t+"%"}function DomView(t){return this.elements=[],this.container=t.container,this.newElement=t.newElement,this.toElement=t.toElement,this}function elemWithClasses(t){for(var e=document.createElement(t),n=1;n<arguments.length;n++)e.classList.add(arguments[n]);return e}function getTimeSeconds(){return(new Date).getTime()/1e3}function getRelativeCoordinates(t,e){var n,i;t=t||window.event;var o=t.target||t.srcElement;if(window.opera){var a=getAbsolutePosition(e);n=t.pageX-a.x,i=t.pageY-a.y}else{var a={};if("touchend"===t.type||"touchstart"===t.type||"touchmove"===t.type){var s=t.changedTouches[0];if("undefined"!=typeof s){var r=o.getBoundingClientRect(),c={top:r.top+document.body.scrollTop,left:r.left+document.body.scrollLeft};return a.x=s.pageX-c.left,a.y=s.pageY-c.top,a}}a.x=t.offsetX,a.y=t.offsetY;for(var l=o;l;)l.mouseX=a.x,l.mouseY=a.y,a.x+=l.offsetLeft,a.y+=l.offsetTop,l=l.offsetParent;for(var l=e,c={x:0,y:0};l;){if("undefined"!=typeof l.mouseX){n=l.mouseX-c.x,i=l.mouseY-c.y;break}c.x+=l.offsetLeft,c.y+=l.offsetTop,l=l.offsetParent}for(l=o;l;)l.mouseX=void 0,l.mouseY=void 0,l=l.offsetParent}return{x:n,y:i}}function relativeClickHandler(t,e){var n={down:!1},i=function(i){return function(o){if(o.preventDefault(),i==MouseState.Down){if(n.down)return!1;n.down=!0}else if(i==MouseState.Up){if(!n.down)return!1;n.down=!1}else if(i==MouseState.Move&&!n.down)return;var a=t.clientWidth||t.offsetWidth||1e4,s=t.clientHeight||t.offsetHeight||1e4,r=getRelativeCoordinates(o,t);r.x/=a,r.y/=s,r.x<0&&(r.x=0),r.y<0&&(r.y=0),r.x>=1&&(r.x=1),r.y>=1&&(r.y=1),e(i,r)}};t.addEventListener("mousedown",i(MouseState.Down)),t.addEventListener("touchstart",i(MouseState.Down)),t.addEventListener("mousemove",i(MouseState.Move)),t.addEventListener("touchmove",i(MouseState.Move)),t.addEventListener("mouseup",i(MouseState.Up)),t.addEventListener("touchend",i(MouseState.Up)),t.addEventListener("mouseout",i(MouseState.Up))}function epsilonFix(t,e,n){return Math.abs(t-e)<n?t:e}function registerFullscreenCallback(t){document.addEventListener("fullscreenchange",t),document.addEventListener("mozfullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),document.addEventListener("MSfullscreenchange",t)}function requestFullscreenElement(t){t.requestFullscreen?t.requestFullscreen():t.msRequestFullscreen?t.msRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen()}function removeFullscreenElement(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function getFullscreenElement(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||null}function isFullscreenElement(t){return t==getFullscreenElement()}function propCompare(t,e){return t>e?1:t<e?-1:0}function annotationCompare(t,e){return propCompare(t.time,e.time)||propCompare(t.position.x,e.position.x)||propCompare(t.position.y,e.position.y)||propCompare(t.text,e.text)||propCompare(t.user.id,e.user.id)||propCompare(t.user.uri,e.user.uri)||propCompare(t.user.name,e.user.name)||0}function normalizeManifest(t){t.annotations.sort(annotationCompare)}function fnv1aHashString(t){for(var e=2166136261,n=0,i=t.length;n<i;n++)e^=t.charCodeAt(n),e+=(e<<1)+(e<<4)+(e<<7)+(e<<8)+(e<<24);return e}function getAnnotationColorForHash(t){var e=["#cc2929","#cc5f29","#cc9629","#cccc29","#96cc29","#5fcc29","#29cc29","#29cc5f","#29cc96","#29cccc","#2996cc","#295fcc","#2929cc","#5f29cc","#9629cc","#cc29cc"],n=t%(e.length-1);return n<0&&(n*=-1),e[n]}!function(t){"use strict";var e,n=t.Base64,i="2.1.9";if("undefined"!=typeof module&&module.exports)try{e=require("buffer").Buffer}catch(t){}var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=function(t){for(var e={},n=0,i=t.length;n<i;n++)e[t.charAt(n)]=n;return e}(o),s=String.fromCharCode,r=function(t){if(t.length<2){var e=t.charCodeAt(0);return e<128?t:e<2048?s(192|e>>>6)+s(128|63&e):s(224|e>>>12&15)+s(128|e>>>6&63)+s(128|63&e)}var e=65536+1024*(t.charCodeAt(0)-55296)+(t.charCodeAt(1)-56320);return s(240|e>>>18&7)+s(128|e>>>12&63)+s(128|e>>>6&63)+s(128|63&e)},c=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,l=function(t){return t.replace(c,r)},h=function(t){var e=[0,2,1][t.length%3],n=t.charCodeAt(0)<<16|(t.length>1?t.charCodeAt(1):0)<<8|(t.length>2?t.charCodeAt(2):0),i=[o.charAt(n>>>18),o.charAt(n>>>12&63),e>=2?"=":o.charAt(n>>>6&63),e>=1?"=":o.charAt(63&n)];return i.join("")},u=t.btoa?function(e){return t.btoa(e)}:function(t){return t.replace(/[\s\S]{1,3}/g,h)},d=e?function(t){return(t.constructor===e.constructor?t:new e(t)).toString("base64")}:function(t){return u(l(t))},p=function(t,e){return e?d(String(t)).replace(/[+\/]/g,function(t){return"+"==t?"-":"_"}).replace(/=/g,""):d(String(t))},m=function(t){return p(t,!0)},y=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g"),f=function(t){switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),n=e-65536;return s((n>>>10)+55296)+s((1023&n)+56320);case 3:return s((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return s((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},v=function(t){return t.replace(y,f)},S=function(t){var e=t.length,n=e%4,i=(e>0?a[t.charAt(0)]<<18:0)|(e>1?a[t.charAt(1)]<<12:0)|(e>2?a[t.charAt(2)]<<6:0)|(e>3?a[t.charAt(3)]:0),o=[s(i>>>16),s(i>>>8&255),s(255&i)];return o.length-=[0,0,2,1][n],o.join("")},A=t.atob?function(e){return t.atob(e)}:function(t){return t.replace(/[\s\S]{1,4}/g,S)},g=e?function(t){return(t.constructor===e.constructor?t:new e(t,"base64")).toString()}:function(t){return v(A(t))},w=function(t){return g(String(t).replace(/[-_]/g,function(t){return"-"==t?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},P=function(){var e=t.Base64;return t.Base64=n,e};if(t.Base64={VERSION:i,atob:A,btoa:u,fromBase64:w,toBase64:p,utob:l,encode:p,encodeURI:m,btou:v,decode:w,noConflict:P},"function"==typeof Object.defineProperty){var b=function(t){return{value:t,enumerable:!1,writable:!0,configurable:!0}};t.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",b(function(){return w(this)})),Object.defineProperty(String.prototype,"toBase64",b(function(t){return p(this,t)})),Object.defineProperty(String.prototype,"toBase64URI",b(function(){return p(this,!0)}))}}t.Meteor&&(Base64=t.Base64)}(this);var AchSoPlayer=function(t,e,n,i){this.start(t,e||{},n||null,i||{})};AchSoPlayer.prototype.start=function(t,e,n,i){this.loaded=!1,this.options=i,this.startModel(e,n),this.startView(t,e),this.startController(),this.switchState(ManualPause),this.loaded=!0,this.notifyLoaded()},AchSoPlayer.prototype.reset=function(t){this.resetModel(t),this.resetView(t),this.resetController(t)},AchSoPlayer.prototype.stop=function(){this.stopView()};var achso_player_actions={},Initial=0,Playing=1,ManualPause=2,AnnotationPause=3,AnnotationEdit=4;AchSoPlayer.prototype.startController=function(){this.previousTime=0,this.actions=achso_player_actions[ManualPause],this.state=Initial,this.timeouts=[]},AchSoPlayer.prototype.resetController=function(t){this.batch&&this.setBatch(this.batchAt(this.time)),this.updateSeekBarView(),this.updateAnnotationView()},AchSoPlayer.prototype.activate=function(){this.active=!0,this.switchState(ManualPause),this.options.startTime?this.userSeek(this.options.startTime,MouseState.Up):this.userSeek(0,MouseState.Up),this.updateSeekBarView(),this.updateAnnotationView()},AchSoPlayer.prototype.stateTimeout=function(t,e){this.timeouts.push(window.setTimeout(t.bind(this),1e3*e))},AchSoPlayer.prototype.switchState=function(t){for(var e=0;e<this.timeouts.length;e++)window.clearTimeout(this.timeouts[e]);return this.timeouts.length=0,this.unselectAnnotation(),this.stopWaitAnimation(),this.actions=achso_player_actions[t],this.actions.start&&this.actions.start.apply(this,Array.prototype.slice.call(arguments,1)),this.state=t,this.setPlayButton(t==Initial||t==ManualPause||t==AnnotationEdit),t==ManualPause&&this.options.lazyLoadVideo&&this.setPlayButton(!0,!0),this.updateSeekBarView(),this.updateUndoButtonsView(),this},AchSoPlayer.prototype.timeUpdate=function(t){this.isSeeking||(this.time=t,this.actions.timeUpdate&&this.actions.timeUpdate.call(this,t,this.previousTime)),this.previousTime=t,this.isSeeking=!1},AchSoPlayer.prototype.userPlay=function(){this.actions.userPlay&&this.actions.userPlay.call(this)},AchSoPlayer.prototype.userSeek=function(t,e){this.actions.userSeek&&this.actions.userSeek.call(this,t,e)},AchSoPlayer.prototype.editAnnotation=function(t){this.actions.editAnnotation&&this.actions.editAnnotation.call(this,t)},AchSoPlayer.prototype.doSeek=function(t){this.isSeeking=!0,this.time=t,this.seekVideo(t),this.setBarPosition(t)},AchSoPlayer.prototype.stopOnEnd=function(){this.switchState(ManualPause)},AchSoPlayer.prototype.doUndo=function(){this.canUndo()&&(this.unselectAnnotation(),this.commitUndo()?this.postUndoRedo():(this.updateAnnotationView(),this.updateUndoButtonsView()))},AchSoPlayer.prototype.doRedo=function(){this.canRedo()&&(this.unselectAnnotation(),this.commitRedo()?this.postUndoRedo():(this.updateAnnotationView(),this.updateUndoButtonsView()))},AchSoPlayer.prototype.postUndoRedo=function(){this.setBarPosition(this.time),this.seekVideo(this.time),this.unselectAnnotation(),this.switchState(AnnotationEdit),this.updateSeekBarView(),this.updateAnnotationView(),this.updateUndoButtonsView()},AchSoPlayer.prototype.selectAnnotation=function(t,e){this.selectedUndoPoint=e||this.createUndoPoint(),this.oldSelectedAnnotation=this.selectedAnnotation,this.selectedAnnotation=t,this.showAnnotationEdit(t)},AchSoPlayer.prototype.unselectAnnotation=function(){this.selectedAnnotation=null,this.hideAnnotationEdit()},AchSoPlayer.prototype.selectedAnnotationMutated=function(){this.selectedUndoPoint&&(this.commitUndoPoint(this.selectedUndoPoint),this.selectedUndoPoint=null,this.updateUndoButtonsView())},AchSoPlayer.prototype.doEditAnnotation=function(t){if(t.state==MouseState.Down){var e=this.createUndoPoint();this.batch||this.setBatch(this.findOrCreateBatch(this.time));var n=this.findOrCreateAnnotation(t.pos),i=n.annotation;if(i.isNew=n.isNew,!i.isNew&&this.options.ownEditOnly&&i.author.id!=this.user.id)return;n.isNew&&this.updateSeekBarView(),this.dragging=n.isNew,this.selectAnnotation(i,e),this.annotationDeadZoneBroken=!1,this.annotationPressStart(),n.isNew&&this.selectedAnnotationMutated(),this.dragPosDiff={x:i.pos.x-t.pos.x,y:i.pos.y-t.pos.y},this.dragStartPos={x:i.pos.x,y:i.pos.y}}else{var i=this.selectedAnnotation;if(i){t.state!=MouseState.Up||this.dragging||i!=this.oldSelectedAnnotation||this.unselectAnnotation();var o={x:clamp(t.pos.x+this.dragPosDiff.x,0,1),y:clamp(t.pos.y+this.dragPosDiff.y,0,1)},a=(o.x-this.dragStartPos.x)*this.videoWidth,s=(o.y-this.dragStartPos.y)*this.videoHeight;a*a+s*s>Math.pow(this.annotationDragDeadZone,2)&&(this.annotationDeadZoneBroken||this.annotationDragStart(),this.dragging=!0,this.annotationDeadZoneBroken=!0,this.selectedAnnotationMutated()),t.state==MouseState.Up&&(this.annotationDragStop(),this.annotationPressStop()),this.dragging&&(i.pos.x=o.x,i.pos.y=o.y)}}this.updateAnnotationView()},AchSoPlayer.prototype.annotationTextInput=function(t){this.selectedAnnotation&&(this.selectedAnnotation.text=t,this.updateAnnotationView(),this.selectedAnnotationMutated())},AchSoPlayer.prototype.annotationSaveButton=function(){this.notifyAnnotationEditedOrCreated(this.selectedAnnotation,this.getAnnotationIndex(this.selectedAnnotation)),this.unselectAnnotation(),this.updateAnnotationView(),this.updateAnnotationHTMLView()},AchSoPlayer.prototype.annotationDeleteButton=function(){this.selectedAnnotation&&(this.saveUndoPoint(),this.updateUndoButtonsView(),this.notifyAnnotationDeleted(this.selectedAnnotation,this.getAnnotationIndex(this.selectedAnnotation)),this.deleteAnnotation(this.selectedAnnotation),this.unselectAnnotation(),this.updateAnnotationHTMLView(),this.updateAnnotationView(),this.updateSeekBarView())},AchSoPlayer.prototype.notifyLoaded=function(){this.notifyParent("player:loaded",{})},AchSoPlayer.prototype.notifyAnnotationEditedOrCreated=function(t,e){var n=t.isNew,i=this.exportAnnotation(t);n?this.notifyParent("annotation:created",{annotation:i,index:e}):this.notifyParent("annotation:updated",{annotation:i,index:e})},AchSoPlayer.prototype.notifyAnnotationDeleted=function(t,e){var n=this.exportAnnotation(t);this.notifyParent("annotation:deleted",{annotation:n,index:e})},AchSoPlayer.prototype.notifyParent=function(t,e){(this.loaded||"player:loaded"==t)&&(this.data.id&&(e.id=this.data.id),this.data.type&&(e.from=this.data.type),window.parent.postMessage(JSON.stringify({data:e,type:t}),"*"))},achso_player_actions[Initial]={},achso_player_actions[Playing]={start:function(t){this.playVideo(),this.ignoreBatch=this.batch,this.setBatch(null)},timeUpdate:function(t,e){var n=t-e,i=t+n;this.setBarPosition(t);var o=this.batchBetween(e,i);if(o&&o!=this.ignoreBatch)if(o.time>t){var a=o.time-t;this.stateTimeout(function(){this.setBatch(o),this.setBarPosition(this.batch.time),this.time=this.batch.time,this.switchState(AnnotationPause)},a)}else this.setBatch(o),this.updateAnnotationView(),this.setBarPosition(this.batch.time),this.time=this.batch.time,this.switchState(AnnotationPause)},userSeek:function(t,e){e==MouseState.Down&&this.pauseVideo();var n=this.batchNear(t,this.snapDistance);n&&(t=n.time),this.setBatch(n),ignoreBatch=n,this.doSeek(t),e==MouseState.Up&&(this.batch?this.switchState(ManualPause):this.playVideo())},userPlay:function(){this.switchState(ManualPause)},editAnnotation:function(t){this.allowEdit()&&this.switchState(AnnotationEdit).editAnnotation(t)}},achso_player_actions[ManualPause]={start:function(){this.pauseVideo()},timeUpdate:function(t){this.setBarPosition(t)},userPlay:function(){this.switchState(Playing)},userSeek:function(t){var e=this.batchNear(t,this.snapDistance);e&&(t=e.time),this.setBatch(e),this.doSeek(t)},editAnnotation:function(t){this.allowEdit()&&this.switchState(AnnotationEdit).editAnnotation(t)}},achso_player_actions[AnnotationPause]={start:function(t,e){e=e||!1;var n,i;e?(n=this.batchNear(t,this.snapDistance),i=this.calculateWaitTime(n),this.pauseVideo(),this.setBatch(n),this.updateAnnotationView()):(n=this.batch,i=this.calculateWaitTime(n),this.pauseVideo()),this.doWaitAnimation(i),this.stateTimeout(function(){this.switchState(Playing)},i)},userSeek:function(t){this.batch=null,this.switchState(Playing).userSeek(t)},userPlay:function(){this.switchState(ManualPause)},editAnnotation:function(t){this.allowEdit()&&this.switchState(AnnotationEdit).editAnnotation(t)}},achso_player_actions[AnnotationEdit]={start:function(){this.pauseVideo()},userSeek:function(t){this.switchState(ManualPause).userSeek(t)},userPlay:function(){this.switchState(Playing)},editAnnotation:function(t){this.doEditAnnotation(t)}},AchSoPlayer.prototype.startModel=function(t,e){this.batches=[],this.data=t,this.user=e,this.time=0,this.active=!1,this.annotationSelectRadius=50,this.annotationDragDeadZone=10,this.snapDistance=.05,this.importManifest(t),this.undoStream=[],this.redoStream=[],this.maxUndoDepth=100},AchSoPlayer.prototype.resetModel=function(t){this.batches=[],this.data=t,this.importManifest(t),this.undoStream=[],this.redoStream=[]},AchSoPlayer.prototype.importManifest=function(t){if(this.manifest=t,t.annotations)for(var e=0;e<t.annotations.length;e++)this.addAnnotation(this.importAnnotation(t.annotations[e]))},AchSoPlayer.prototype.importAnnotation=function(t){return{original:t,author:t.author,pos:t.position,text:t.text,time:t.time/1e3,createdTimestamp:t.createdTimestamp}},AchSoPlayer.prototype.exportManifest=function(t){for(var t=cloneDeep(this.manifest),e=[],n=0;n<this.batches.length;n++)for(var i=this.batches[n],o=0;o<i.annotations.length;o++){var a=i.annotations[o];e.push(this.exportAnnotation(a))}return t.annotations=e,normalizeManifest(t),t},AchSoPlayer.prototype.exportAnnotation=function(t){var e=Math.round(1e3*t.time),n=t.pos.x,i=t.pos.y,o=t.original;o&&(e=epsilonFix(o.time,e,.5),n=epsilonFix(o.x,n,5e-4),i=epsilonFix(o.y,i,5e-4));var a={author:t.author,position:{x:n,y:i},text:t.text,time:e};return t.createdTimestamp&&(a.createdTimestamp=t.createdTimestamp),a},AchSoPlayer.prototype.allowEdit=function(){return!this.options.viewOnly&&!!this.user},AchSoPlayer.prototype.createUndoPoint=function(){return{time:this.time,batches:cloneDeep(this.batches),batchIndex:this.batches.indexOf(this.batch)}},AchSoPlayer.prototype.commitUndoPoint=function(t){this.redoStream=[],this.undoStream.push(t),this.undoStream.length>this.maxUndoDepth&&this.undoStream.shift()},AchSoPlayer.prototype.saveUndoPoint=function(){this.commitUndoPoint(this.createUndoPoint())},AchSoPlayer.prototype.restoreState=function(t,e){var n=t.pop();return!!n&&(e.push({time:this.time,batches:this.batches,batchIndex:this.batches.indexOf(this.batch)}),this.time=n.time,this.batches=n.batches,n.batchIndex>=0?this.batch=this.batches[n.batchIndex]:this.batch=null,!0)},AchSoPlayer.prototype.commitUndo=function(){return this.restoreState(this.undoStream,this.redoStream)},AchSoPlayer.prototype.commitRedo=function(){return this.restoreState(this.redoStream,this.undoStream)},AchSoPlayer.prototype.canUndo=function(){return this.undoStream.length>0},AchSoPlayer.prototype.canRedo=function(){return this.redoStream.length>0},AchSoPlayer.prototype.batchNear=function(t,e){for(var n=null,i=0;i<this.batches.length;i++){var o=Math.abs(this.batches[i].time-t);o<e&&(e=o,n=this.batches[i])}return n},AchSoPlayer.prototype.batchAt=function(t){return this.batchNear(t,.01)},AchSoPlayer.prototype.batchBetween=function(t,e){for(var n=0;n<this.batches.length;n++){var i=this.batches[n].time;if(t<i&&i<=e)return this.batches[n];if(e<i)break}return null},AchSoPlayer.prototype.createBatch=function(t){var e;for(e=0;e<this.batches.length&&!(this.batches[e].time>t);e++);var n={time:t,annotations:[]};return this.batches.splice(e,0,n),this.loaded&&this.updateSeekBarView(),n},AchSoPlayer.prototype.setBatch=function(t){this.batch=t,this.loaded&&this.updateAnnotationView()},AchSoPlayer.prototype.findOrCreateAnnotation=function(t){for(var e=this.batch,n=e.annotations,i=null,o=Math.pow(this.annotationSelectRadius,2),a=0;a<n.length;a++){var s=n[a],r=(s.pos.x-t.x)*this.videoWidth,c=(s.pos.y-t.y)*this.videoHeight,l=r*r+c*c;l<o&&(o=l,i=s)}if(i)return{annotation:i,isNew:!1};var h={original:null,author:this.user,pos:{x:t.x,y:t.y},time:e.time,text:"",createdTimestamp:(new Date).toISOString()};return e.annotations.push(h),{annotation:h,isNew:!0}},AchSoPlayer.prototype.findOrCreateBatch=function(t){var e=this.batchAt(t);return e||(e=this.createBatch(t)),e},AchSoPlayer.prototype.addAnnotation=function(t){var e=this.findOrCreateBatch(t.time);e.annotations.push(t)},AchSoPlayer.prototype.getAnnotationIndex=function(t){var e=this.batchAt(t.time);if(!e)return-1;var n=this.batches.indexOf(e),i=e.annotations.indexOf(t);return n+i},AchSoPlayer.prototype.deleteAnnotation=function(t){var e=this.batchAt(t.time);if(e){var n=e.annotations.indexOf(t);if(!(n<0||(e.annotations.splice(n,1),e.annotations.length>0))){var i=this.batches.indexOf(e);i<0||(this.batches.splice(i,1),this.batch==e&&(this.batch=null))}}},AchSoPlayer.prototype.calculateAnnotationWaitTime=function(t){for(var e=2,n=.5,i=1,o=.03,a=10,s=e,r=0;r<t.length;r++){s+=n;var c=t[r].text.replace(/\s+/g,"");c.length>0&&(s+=i,s+=c.length*o)}return s=Math.min(s,a)},AchSoPlayer.prototype.calculateWaitTime=function(t){return t&&0!=t.annotations.length?this.calculateAnnotationWaitTime(t.annotations):1},AchSoPlayer.prototype.setDreamUser=function(t){this.dreamUser=t},DomView.prototype.update=function(t){for(var e=0;this.elements.length<t.length;){var n=this.newElement(t[e]);n.style.visibility="hidden",this.container.appendChild(n),this.elements.push(n),e+=1}for(var e=t.length;e<this.elements.length;e++)this.elements[e].style.visibility="hidden";for(var e=0;e<t.length;e++)this.toElement(this.elements[e],t[e]),this.elements[e].style.visibility="visible"};var MouseState={Up:1,Move:2,Down:3};AchSoPlayer.prototype.fetchElements=function(t){this.elements={root:t,video:t.querySelector(".acp-video"),videoWrapper:t.querySelector(".acp-video-wrapper"),videoBackground:t.querySelector(".acp-video-background"),playButton:t.querySelector(".acp-play-button"),undoButton:t.querySelector(".acp-undo-button"),redoButton:t.querySelector(".acp-redo-button"),fullscreenButton:t.querySelector(".acp-fullscreen-button"),seekBar:t.querySelector(".acp-seek-bar"),seekBarFiller:t.querySelector(".acp-seek-bar-filler"),seekCatcher:t.querySelector(".acp-seek-catcher"),waitBar:t.querySelector(".acp-wait-bar"),waitFade:t.querySelector(".acp-wait-fade"),annotationList:t.querySelector(".acp-annotation-list"),annotationShowListButton:t.querySelector(".acp-annotation-button"),annotationEdit:t.querySelector(".acp-annotation-edit"),annotationTextInput:t.querySelector(".acp-annotation-text-input"),annotationSaveButton:t.querySelector(".acp-annotation-save-button"),annotationDeleteButton:t.querySelector(".acp-annotation-delete-button"),subtitles:t.querySelector(".acp-subtitles"),overlay:t.querySelector(".acp-overlay"),playbackTime:t.querySelector(".current-time"),loadedPercentage:t.querySelector(".acp-loaded")}},AchSoPlayer.prototype.startView=function(t,e){this.fetchElements(t);var n=this;if(this.doingWaitAnimation=!1,this.options.showLoadedPercent||n.elements.loadedPercentage.classList.add("hide"),this.elements.video.addEventListener("loadedmetadata",function(){var t=n.elements.video.videoWidth,e=n.elements.video.videoHeight;n.setVideoSize(t,e),n.activate()}),this.elements.video.addEventListener("durationchange",function(){n.videoDuration=n.elements.video.duration,n.updateSeekBarView()}),this.elements.video.addEventListener("timeupdate",function(){n.timeUpdate(n.elements.video.currentTime)}),this.elements.video.addEventListener("progress",function(t){if(this.buffered.length>0){var e=this.buffered,i=this.duration,o=e.end(0),a=Math.ceil(o/i*100);n.elements.loadedPercentage.innerHTML=a+" %",a>=100&&n.elements.loadedPercentage.classList.add("fade-out")}}),this.elements.video.addEventListener("ended",function(){n.stopOnEnd()}),/firefox/i.test(navigator.userAgent)&&this.elements.video.addEventListener("seeked",function(){n.elements.video.style.display="inline",n.elements.video.offsetHeight,n.elements.video.style.display="block"}),this.elements.playButton.addEventListener("click",function(){n.active&&(n.userPlay(),n.hideOverlay())}),relativeClickHandler(this.elements.seekCatcher,function(t,e){n.userSeek(e.x*n.videoDuration,t)}),this.elements.undoButton.addEventListener("click",function(){n.doUndo()}),this.elements.redoButton.addEventListener("click",function(){n.doRedo()}),this.elements.fullscreenButton.addEventListener("click",function(){n.fullscreenToggle()}),this.options.lazyLoadVideo===!0){var i=function(t){return t.preventDefault(),this.elements.video.removeAttribute("preload"),this.elements.root.removeEventListener("click",i,!1),!1}.bind(this);this.elements.root.addEventListener("click",i,!1)}if(this.elements.fullscreenButton.classList.remove("acp-disabled"),n.updateAnnotationHTMLView()){var o=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;this.elements.annotationShowListButton.classList.remove("acp-disabled"),this.elements.annotationShowListButton.addEventListener("click",function(){n.elements.annotationList.classList.contains("acp-hidden")?(n.elements.annotationList.classList.remove("acp-hidden"),n.elements.subtitles.classList.add("acp-hidden")):(n.elements.annotationList.classList.add("acp-hidden"),n.elements.subtitles.classList.remove("acp-hidden"))}),o<960?(n.elements.annotationList.classList.add("acp-hidden"),n.elements.subtitles.classList.remove("acp-hidden")):(n.elements.annotationList.classList.remove("acp-hidden"),n.elements.subtitles.classList.add("acp-hidden"))}relativeClickHandler(this.elements.video,function(t,e){var i={state:t,pos:e};n.editAnnotation(i)}),this.elements.annotationTextInput.addEventListener("input",function(){n.annotationTextInput(n.elements.annotationTextInput.value)}),this.elements.annotationSaveButton.addEventListener("click",function(){n.annotationSaveButton()}),this.elements.annotationDeleteButton.addEventListener("click",function(){n.annotationDeleteButton()}),window.addEventListener("keydown",function(t){t.target.tagName.match(/input|textarea/i)||(46==t.keyCode?(n.annotationDeleteButton(),t.preventDefault()):32==t.keyCode?(n.userPlay(),t.preventDefault()):t.ctrlKey&&!t.shiftKey&&90==t.keyCode?(n.doUndo(),t.preventDefault()):t.ctrlKey&&!t.shiftKey&&89==t.keyCode?(n.doRedo(),t.preventDefault()):t.ctrlKey&&t.shiftKey&&90==t.keyCode?(n.doRedo(),t.preventDefault()):27==t.keyCode&&removeFullscreenElement())}),this.videoWrapperResizeinterval=window.setInterval(function(){n.poll()},500),this.annotationView=new DomView({container:this.elements.videoWrapper,newElement:function(){var t=elemWithClasses("div","acp-annotation");return t},toElement:function(t,e){e==n.selectedAnnotation?t.classList.add("acp-selected-annotation"):t.classList.remove("acp-selected-annotation");var i={name:"Unknown"};window.player?i=window.player.getAuthorDisplayAssets(e.author):i.name=e.author.name?e.author.name:e.author.username?e.author.username:i.name;var o=fnv1aHashString(i.name),a=getAnnotationColorForHash(o),s="radial-gradient(rgba(255,255,255, 0.0) 37%, rgba(255,255,255, 0.9) 40%, rgba(255,255,255, 0.9) 45%, rgba(68,153,136, 0.8) 47%, rgba(68,153,136, 0.4) 53%, rgba(68,153,136, 0.0) 55%, rgba(68,153,136, 0.0) 56%, "+a+" 60%, "+a+" 62%, rgba(85,204,153, 0.0) 66%)";t.style.left=cssPercent(e.pos.x),t.style.top=cssPercent(e.pos.y),t.style.background=s}}),this.seekBarView=new DomView({container:this.elements.seekBar,newElement:function(t){var e=elemWithClasses("div","acp-seek-annotation"),n=getBatchColor(t);if(n){var i="radial-gradient(rgba(255,0,0, 0.0) 47%, "+n+" 60%, "+n+" 62%, rgba(255,0,0, 0.0) 73%)";e.style.background=i}return e},toElement:function(t,e){var n=getBatchColor(e);if(n){var i="radial-gradient(rgba(255,0,0, 0.0) 47%, "+n+" 60%, "+n+" 62%, rgba(255,0,0, 0.0) 73%)";t.style.background=i}this.state==AnnotationPause?t.classList.add("acp-waiting"):t.classList.remove("acp-waiting"),t.style.left=cssPercent(e.time/this.videoDuration)}.bind(this)}),registerFullscreenCallback(function(){n.poll()}),this.elements.video.src=e.videoUri,this.poll(),this.options.lazyLoadVideo===!0},AchSoPlayer.prototype.resetView=function(){},AchSoPlayer.prototype.stopView=function(){window.clearInterval(this.videoWrapperResizeInterval)},AchSoPlayer.prototype.setBarPosition=function(t){this.lastBarPosition=t,this.elements.playbackTime.innerHTML=dateToMMSS(t),this.elements.seekBarFiller.style.width=cssPercent(t/this.videoDuration)},AchSoPlayer.prototype.hideOverlay=function(){player.elements.overlay&&(player.elements.overlay.classList.contains("acp-overlay-hidden")||(player.elements.overlay.classList.add("acp-overlay-hidden"),window.setTimeout(function(){player.elements.overlay.classList.add("acp-force-hidden-no-layout")},300)))},AchSoPlayer.prototype.setVideoSize=function(t,e){this.videoWidth=t,this.videoHeight=e,this.videoAspect=t/e,this.updateVideoWrapperSize()},AchSoPlayer.prototype.fullscreenToggle=function(){isFullscreenElement(player.elements.root)?removeFullscreenElement():requestFullscreenElement(player.elements.root)},AchSoPlayer.prototype.poll=function(){isFullscreenElement(this.elements.root)?(this.elements.root.classList.add("acp-fullscreen"),this.elements.root.classList.remove("acp-inline"),this.elements.fullscreenButton.innerHTML="&#xE5D1;"):(this.elements.root.classList.remove("acp-fullscreen"),this.elements.root.classList.add("acp-inline"),this.elements.fullscreenButton.innerHTML="&#xE5D0;"),this.allowEdit()?(this.elements.undoButton.classList.remove("acp-force-hidden-no-layout"),this.elements.redoButton.classList.remove("acp-force-hidden-no-layout")):(this.elements.undoButton.classList.add("acp-force-hidden-no-layout"),this.elements.redoButton.classList.add("acp-force-hidden-no-layout"));var t=this;window.setTimeout(function(){t.updateVideoWrapperSize()},50)},AchSoPlayer.prototype.updateVideoWrapperSize=function(t,e){if(this.videoAspect){var n=this.elements.videoBackground.clientWidth,i=this.elements.videoBackground.clientHeight,o=n/i;this.videoAspect>=o?(this.playerWidth=n,this.playerHeight=this.playerWidth/this.videoAspect):(this.playerHeight=i,this.playerWidth=this.playerHeight*this.videoAspect),this.elements.videoWrapper.style.width=this.playerWidth+"px",this.elements.videoWrapper.style.height=this.playerHeight+"px";var a=n/30;a=clamp(a,20,35),a=Math.round(a),this.elements.subtitles.style.fontSize=a+"px";var s=Math.round(a/6);this.elements.subtitles.style.textShadow="0px 0px "+s+"px #000";var r=20;this.snapDistance=this.videoDuration*(r/n)}},AchSoPlayer.prototype.pauseVideo=function(){this.elements.video.pause()},AchSoPlayer.prototype.playVideo=function(){this.elements.video.play()},AchSoPlayer.prototype.seekVideo=function(t){isNaN(t)||(this.elements.video.currentTime=t)},AchSoPlayer.prototype.setPlayButton=function(t,e){var n=this.elements.playButton;this.active||e?n.classList.remove("acp-disabled"):n.classList.add("acp-disabled"),t?n.innerHTML="&#xE037;":n.innerHTML="&#xE034;"},AchSoPlayer.prototype.tryFindingMentorBatch=function(t){return t.sort(function(t,e){return new Date(t.annotations[0].createdTimestamp).getTime()-new Date(e.annotations[0].createdTimestamp).getTime()}),t[0]},AchSoPlayer.prototype.showHideAuthorNames=function(){for(var t=document.querySelectorAll(".a-name"),e=0;e<t.length;e++){var n=t[e].style.display;t[e].style.display="inline"==n?"none":"inline"}},AchSoPlayer.prototype.getAuthorDisplayAssets=function(t,e){e=e||null,t=t||null;var n={dream_user:'<span class="a-icon">&#x265f;</span>',mentor:'<span class="a-icon">&#x2654;</span>',other:'<span class="a-icon">&#x2659;</span>'},i="Unknown",o=n.other,a=i,s=o,r=this.dreamUser||void 0,c=t&&t.email?t.email.split("@")[0]:null,l=!!(t&&t.email&&e&&e.email&&t.email==e.email),h=!!(t&&t.email&&r&&r.id==c);return l?(s=n.mentor,a=t.name?t.name:t.username?t.username:t.email?t.email:t.id?t.id:a):h?(s=n.dream_user,a=r.name?r.name:r.username?r.username:r.id?r.id:a):(s=n.other,a=t.name?t.name:t.username?t.username:t.email?t.email:t.id?t.id:a),{name:a,icon:s}},AchSoPlayer.prototype.updateAnnotationHTMLView=function(){var t,e,n,i=!1,o=this.batches,a="",s="color: white;",r='<span class="a-icon">&#x2659;</span>';if(o&&o.length>0){e=this.tryFindingMentorBatch(o),n=e.annotations[0],a="<p><ul>",t="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;";for(var c=0;c<o.length;c++){var l,h,u,d,p,m,y,f;if(l=o[c].time,
h=dateToMMSS(l),u=o[c].annotations[0],d=""!=u.text?stringToHTMLSafe(u.text):"&lt;no caption&gt;",m="window.player.switchState(AnnotationPause, "+l+", true);window.player.doSeek("+l+");",y="Unknown",f=r,u.author){var v=this.getAuthorDisplayAssets(u.author,n.author);y=v.name,f=v.icon}p=f+"<span class='a-name' style='display: none;'> / "+y+"</span>";var S=getAnnotationColorForHash(fnv1aHashString(y));a+="<li style='"+t+"'><strong style='color: "+S+"'>["+h+" / "+p+"]</strong> <a href='#' onclick='"+m+"' style='"+s+"'>"+d+"</a></li>"}a+="</ul></p>",i=!0}else this.elements.annotationShowListButton.classList.add("acp-disabled"),a="<p><strong>No annotations / captions found</strong></p>",i=!1;return a+="<br><p align='left'>",a+="<a href='#' onclick='window.player.showHideAuthorNames()' style='"+s+" font-weight: bold;'>Toggle names</a>",a+=" | <a href='#' onclick='window.player.updateAnnotationHTMLView()' style='"+s+" font-weight: bold;'>Refresh</a></p>",this.elements.annotationList.innerHTML=a,i},AchSoPlayer.prototype.showAnnotationEdit=function(t){this.elements.subtitles.classList.add("acp-hidden"),this.elements.annotationEdit.classList.add("acp-visible"),this.elements.annotationTextInput.value=t.text},AchSoPlayer.prototype.hideAnnotationEdit=function(){this.elements.subtitles.classList.remove("acp-hidden"),this.elements.annotationEdit.classList.remove("acp-visible"),this.elements.annotationEdit.classList.remove("acp-transparent"),this.elements.annotationTextInput.blur()},AchSoPlayer.prototype.annotationDragStart=function(){this.elements.annotationEdit.classList.add("acp-transparent")},AchSoPlayer.prototype.annotationDragStop=function(){this.elements.annotationEdit.classList.remove("acp-transparent")},AchSoPlayer.prototype.annotationPressStart=function(){this.elements.annotationEdit.classList.add("acp-noclick"),this.elements.seekCatcher.classList.add("acp-disable")},AchSoPlayer.prototype.annotationPressStop=function(){this.elements.annotationEdit.classList.remove("acp-noclick"),this.elements.seekCatcher.classList.remove("acp-disable")},AchSoPlayer.prototype.updateAnnotationView=function(){var t;t=this.active&&this.batch?this.batch.annotations:[],this.annotationView.update(t);for(var e=[],n=0;n<t.length;n++){var i=t[n].text.trim();""!=i&&e.push("<span>"+stringToHTMLSafe(i)+"</span>")}var o=e.join("");this.elements.subtitles.innerHTML=o},AchSoPlayer.prototype.updateSeekBarView=function(){var t;t=this.active?this.batches:[],this.seekBarView.update(t),this.state==AnnotationPause?this.elements.seekBarFiller.classList.add("acp-waiting"):this.elements.seekBarFiller.classList.remove("acp-waiting")},AchSoPlayer.prototype.doWaitAnimation=function(t){this.doingWaitAnimation=!0,this.waitAnimationStart=getTimeSeconds(),this.waitAnimationDuration=t,this.elements.waitFade.style.transition="",this.elements.waitFade.style.width="0%",this.elements.waitFade.style.opacity="1.0",this.elements.waitBar.style.transition="width "+t+"s linear",this.elements.waitBar.style.width="100%"},AchSoPlayer.prototype.stopWaitAnimation=function(){if(this.doingWaitAnimation){this.doingWaitAnimation=!1;var t=getTimeSeconds(),e=t-this.waitAnimationStart,n=Math.min(e/this.waitAnimationDuration,1);this.elements.waitBar.style.transition="",this.elements.waitBar.style.width="0%",this.elements.waitFade.style.transition="opacity 0.2s ease-out",this.elements.waitFade.style.width=cssPercent(n),this.elements.waitFade.style.opacity="0.0"}},AchSoPlayer.prototype.updateUndoButtonsView=function(t,e){this.active&&this.canUndo()?this.elements.undoButton.classList.remove("acp-disabled"):this.elements.undoButton.classList.add("acp-disabled"),this.active&&this.canRedo()?this.elements.redoButton.classList.remove("acp-disabled"):this.elements.redoButton.classList.add("acp-disabled")};